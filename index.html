<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片展示</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center; /* Changed back to center */
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: sans-serif;
            /* Removed padding-top as it's not needed with centering */
        }

        #playerControlsContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align items to the right */
            /* background-color: rgba(255, 255, 255, 0.95); */ /* Original background color, replaced by image */
            background-image: url('src/music/今天你要嫁给我/109951166916020363.jpg');
            background-size: cover;
            background-position: center;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            gap: 10px; /* Space between items in the container */
            /* Responsive sizing for different screens */
            width: 250px;
            max-width: 80vw;
        }

        img.main-image { /* Added a class for the main image to distinguish */
            max-width: 50%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        audio {
            /* Removed fixed positioning, now part of playerControlsContainer */
            width: 100%; /* Use full width of container */
            max-width: 220px; /* Maximum width */
            /* Potentially add some styling to make controls fit better over background */
        }

        #lyricsContainer {
            /* Removed margin-top */
            padding: 8px;
            border: 1px solid #ddd;
            max-height: 100px; /* Adjusted size */
            width: 100%; /* Use full width of container */
            max-width: 200px; /* Maximum width */
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white background */
            /* white-space: pre-wrap; */ /* Removed, as each line will be a p */
            text-align: left; /* Changed to left for better readability */
            font-size: 12px; /* Adjusted size */
            border-radius: 4px; /* Added slight rounding */
        }
        #lyricsContainer p {
            margin: 3px 0;
            padding: 2px 4px;
            transition: background-color 0.3s, color 0.3s, transform 0.3s;
            border-radius: 3px;
        }
        #lyricsContainer p.highlight {
            background-color: rgba(0, 0, 0, 0.1);
            color: #000;
            font-weight: bold;
            transform: scale(1.05);
        }

        /* 添加媒体查询，针对移动设备进行优化 */
        @media (max-width: 768px) {
            img.main-image {
                max-width: 80%; /* 在手机上显示更大的图片 */
                margin-bottom: 20px;
            }

            #playerControlsContainer {
                bottom: 10px;
                right: 10px;
                padding: 10px;
                width: 220px; /* 稍微调整大小 */
            }

            audio {
                width: 100%;
            }

            #lyricsContainer {
                max-height: 80px;
                font-size: 11px;
            }
        }

        /* 针对更小的屏幕 */
        @media (max-width: 480px) {
            img.main-image {
                max-width: 95%; /* 在小屏手机上几乎占满宽度 */
            }

            #playerControlsContainer {
                width: 200px;
                max-width: 90vw;
                bottom: 5px;
                right: 5px;
                padding: 8px;
            }

            #lyricsContainer {
                max-height: 70px;
                padding: 5px;
            }

            #lyricsContainer p {
                margin: 2px 0;
                padding: 1px 3px;
            }
        }
    </style>
    <!-- Removed jsmediatags script -->
</head>
<body>
    <!-- Main image will be at the top/center due to body flex settings -->
    <img class="main-image" src="src/image/1747148129596.jpg" alt="展示图片">

    <div id="playerControlsContainer">
        <div id="lyricsContainer">歌词加载中...</div>
        <!-- Removed <img id="albumArt"> -->
        <audio id="audioPlayer" controls autoplay>
            <source src="src/music/今天你要嫁给我/蔡依林, 陶喆 - 今天你要嫁给我.mp3" type="audio/mpeg">
            您的浏览器不支持 audio 元素。
        </audio>
    </div>

    <script>
        // const albumArtImg = document.getElementById('albumArt'); // Removed
        const lyricsContainer = document.getElementById('lyricsContainer');
        const audioPlayer = document.getElementById('audioPlayer');
        let parsedLyrics = [];
        
        // Auto-play audio when page loads
        window.addEventListener('load', () => {
            // Try to play audio automatically
            const playPromise = audioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    // Auto-play was prevented
                    console.log("Autoplay prevented by browser:", error);
                    // You could show a play button or notification here if needed
                });
            }
        });

        // Album art is now set via CSS background on #playerControlsContainer

        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const lyrics = [];
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;

            for (const line of lines) {
                const match = timeRegex.exec(line);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'), 10); // Ensure 3 digits for ms
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    const text = line.substring(match[0].length).trim();
                    if (text) { // Only add if there is lyric text
                        lyrics.push({ time, text });
                    }
                } else {
                    // Handle lines without standard timestamps (e.g., metadata) if needed, or ignore
                    // For now, we mostly care about lines with lyrics and timestamps.
                    // If it's a line like [ar:Artist], we can add it without a time if desired.
                    if (!line.startsWith('[') && line.trim()) { // Attempt to catch untagged lyric lines if any
                         // lyrics.push({ time: lyrics.length > 0 ? lyrics[lyrics.length-1].time + 0.01 : 0, text: line.trim() });
                    }
                }
            }
            return lyrics.sort((a, b) => a.time - b.time);
        }

        function displayLyrics() {
            lyricsContainer.innerHTML = ''; // Clear previous lyrics
            parsedLyrics.forEach((line, index) => {
                const p = document.createElement('p');
                p.textContent = line.text;
                p.dataset.index = index;
                lyricsContainer.appendChild(p);
            });
        }

        let currentLyricIndex = -1;

        audioPlayer.addEventListener('timeupdate', () => {
            if (!parsedLyrics.length) return;

            const currentTime = audioPlayer.currentTime;
            let newLyricIndex = -1;

            // Find the current lyric line
            for (let i = 0; i < parsedLyrics.length; i++) {
                if (currentTime >= parsedLyrics[i].time) {
                    if (i + 1 < parsedLyrics.length && currentTime < parsedLyrics[i+1].time) {
                        newLyricIndex = i;
                        break;
                    } else if (i + 1 === parsedLyrics.length) { // Last lyric line
                        newLyricIndex = i;
                        break;
                    }
                } else if (i === 0 && currentTime < parsedLyrics[i].time) { // Before the first lyric
                    newLyricIndex = -1; // Or handle as a special case, e.g. show first lyric dimmed
                    break;
                }
            }
            // More robust way to find the current lyric index
            newLyricIndex = parsedLyrics.findIndex((line, index) => {
                const nextLine = parsedLyrics[index + 1];
                return currentTime >= line.time && (nextLine ? currentTime < nextLine.time : true);
            });


            if (newLyricIndex !== currentLyricIndex) {
                const oldLyricElement = lyricsContainer.querySelector(`p.highlight`);
                if (oldLyricElement) {
                    oldLyricElement.classList.remove('highlight');
                }

                if (newLyricIndex !== -1) {
                    const newLyricElement = lyricsContainer.querySelector(`p[data-index="${newLyricIndex}"]`);
                    if (newLyricElement) {
                        newLyricElement.classList.add('highlight');
                        // Scroll into view
                        const containerRect = lyricsContainer.getBoundingClientRect();
                        const lyricRect = newLyricElement.getBoundingClientRect();

                        if (lyricRect.bottom > containerRect.bottom || lyricRect.top < containerRect.top) {
                            newLyricElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center' // 'start', 'center', 'end', or 'nearest'
                            });
                        }
                    }
                }
                currentLyricIndex = newLyricIndex;
            }
        });

        // Load and Display Lyrics
        const lrcFilePath = 'src/music/今天你要嫁给我/a829678b430ea29ff29d7f9aa5bfb955.lrc';
        fetch(lrcFilePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                parsedLyrics = parseLRC(text);
                displayLyrics();
            })
            .catch(error => {
                console.error('Error fetching or parsing lyrics:', error);
                lyricsContainer.innerHTML = '<p>歌词加载或解析失败。</p>';
            });
    </script>
</body>
</html>